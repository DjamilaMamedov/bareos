#
# manuals CMakeLists.txt
#

cmake_minimum_required( VERSION 3.0 )

project(bareos-docs NONE)

set( CMAKE_VERBOSE_MAKEFILE off )


###### commands building json files ######
add_custom_command(
  OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-dir-config-schema.json
  COMMAND bareos-dir -xs > /dev/null
  COMMAND bareos-dir -xs > ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-dir-config-schema.json
  DEPENDS bareos-dir )

add_custom_command(
  OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-sd-config-schema.json
  COMMAND bareos-sd -xs > /dev/null
  COMMAND bareos-sd -xs > ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-sd-config-schema.json
  DEPENDS bareos-sd )

add_custom_command(
  OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-fd-config-schema.json
  COMMAND bareos-fd -xs > /dev/null
  COMMAND bareos-fd -xs > ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-fd-config-schema.json
  DEPENDS bareos-fd )

add_custom_command(
  OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bconsole-config-schema.json
  COMMAND bconsole -xs > /dev/null
  COMMAND bconsole -xs > ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bconsole-config-schema.json
  DEPENDS bconsole)

add_custom_command(
  OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-tray-monitor-config-schema.json
  COMMAND bareos-tray-monitor -xs > /dev/null
  COMMAND bareos-tray-monitor -xs > ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-tray-monitor-config-schema.json
  DEPENDS bareos-tray-monitor )


###### commands building rst files from json files ######
set( GENERATE_RESOURCE_DESCRIPTIONS_FROM_JSON_FILES ${PROJECT_SOURCE_DIR}/scripts/generate-resoure-descriptions.py --sphinx --quiet )

add_custom_command( OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-dir-*.rst.inc
  COMMAND ${GENERATE_RESOURCE_DESCRIPTIONS_FROM_JSON_FILES} ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-dir-config-schema.json
  WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
  DEPENDS $<$<BOOL:${docs-build-json}>:${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-dir-config-schema.json>
  VERBATIM )

add_custom_command( OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-sd-*.rst.inc
  COMMAND ${GENERATE_RESOURCE_DESCRIPTIONS_FROM_JSON_FILES} ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-sd-config-schema.json
  WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
  DEPENDS $<$<BOOL:${docs-build-json}>:${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-sd-config-schema.json>
  VERBATIM )

add_custom_command( OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-fd-*.rst.inc
  COMMAND ${GENERATE_RESOURCE_DESCRIPTIONS_FROM_JSON_FILES} ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-fd-config-schema.json
  WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
  DEPENDS $<$<BOOL:${docs-build-json}>:${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-fd-config-schema.json>
  VERBATIM )

add_custom_command( OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bconsole-*.rst.inc
  COMMAND ${GENERATE_RESOURCE_DESCRIPTIONS_FROM_JSON_FILES} ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bconsole-config-schema.json
  WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
  DEPENDS $<$<BOOL:${docs-build-json}>:${PROJECT_SOURCE_DIR}/source/include/autogenerated/bconsole-config-schema.json>
  VERBATIM )

add_custom_command( OUTPUT ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-tray-monitor-*.rst.inc
  COMMAND ${GENERATE_RESOURCE_DESCRIPTIONS_FROM_JSON_FILES} ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-tray-monitor-config-schema.json
  WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
  DEPENDS $<$<BOOL:${docs-build-json}>:${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-tray-monitor-config-schema.json>
  VERBATIM )


IF(${docs-build-json})
  set( CLEAN_JSON_FILES rm -f ${PROJECT_SOURCE_DIR}/source/include/autogenerated/*.json )
ENDIF()

###### target: clean-docs ######
add_custom_target( clean-docs
  COMMAND ${CLEAN_JSON_FILES}
  COMMAND rm -f   ${PROJECT_SOURCE_DIR}/source/include/autogenerated/*.inc
  COMMAND rm -rf  ${PROJECT_BINARY_DIR}/BareosMainReference )


set( AUTOGENERATED_RESOURCE_DESCRIPTION_RST_FILES
  ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-dir-*.rst.inc
  ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-sd-*.rst.inc
  ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-fd-*.rst.inc
  ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bconsole-*.rst.inc
  ${PROJECT_SOURCE_DIR}/source/include/autogenerated/bareos-tray-monitor-*.rst.inc )

###### target: check-git ######
add_custom_target ( check-git
  COMMAND git diff --exit-code --compact-summary ${PROJECT_SOURCE_DIR}/source/include/autogenerated
  DEPENDS ${AUTOGENERATED_RESOURCE_DESCRIPTION_RST_FILES}
  WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
  COMMENT "Comparing json files in \"${PROJECT_SOURCE_DIR}/source/include/autogenerated\" with git repo" )


set( SPHINX_OPTS $ENV{SPHINX_OPTS} )
set( SPHINX_COMMAND sphinx-build )
set( SPHINX_BUILDDIR ${PROJECT_BINARY_DIR}/BareosMainReference )
set( SPHINX_SOURCE_DIR ${PROJECT_SOURCE_DIR}/source )

IF(${docs-only})
  set(DOCS_ALL ALL) #this enables "make docs" by just typing "make"
ENDIF()

###### target: docs ######
add_custom_target( docs ${DOCS_ALL}
  COMMAND ${SPHINX_COMMAND} -M html "${SPHINX_SOURCE_DIR}" "${SPHINX_BUILDDIR}" "${SPHINX_OPTS}"
  DEPENDS $<$<BOOL:${docs-build-json}>:clean-docs>
  DEPENDS check-git )

