
MKDIR=mkdir -p
BAREOS_DIR=../../../../../bareos-master/b/systemtests/sbin/bareos-dir
BAREOS_SD=../../../../../bareos-master/b/systemtests/sbin/bareos-sd
BAREOS_FD=../../../../../bareos-master/b/systemtests/sbin/bareos-fd
BCONSOLE=../../../../../bareos-master/b/systemtests/bin/bconsole
BAREOS_TRAY_MONITOR=../../../../../bareos-master/b/core/src/qt-tray-monitor/bareos-tray-monitor

GENERATED = include/autogenerated/bareos-dir-*.rst.inc \
	include/autogenerated/bareos-sd-*.rst.inc \
	include/autogenerated/bareos-fd-*.rst.inc \
	include/autogenerated/bconsole-*.rst.inc \
	include/autogenerated/bareos-tray-monitor-*.rst.inc

GENERATE_RESOURCE_DESCRIPTIONS=../../scripts/generate-resoure-descriptions.py --sphinx


# You can set these variables from the command line.
SPHINXOPTS    =
SPHINXBUILD   = sphinx-build
SPHINXPROJ    = BareosMainReference
SOURCEDIR     = source
BUILDDIR      = BareosMainReference

all: $(GENERATED) sphinx

include/autogenerated/bareos-dir-*.rst.inc: autogenerated/bareos-dir-config-schema.json
	# generates all director-resource files
	$(GENERATE_RESOURCE_DESCRIPTIONS) autogenerated/bareos-dir-config-schema.json

include/autogenerated/bareos-sd-*.rst.inc: autogenerated/bareos-sd-config-schema.json
	# generates all storage daemon resource files
	$(GENERATE_RESOURCE_DESCRIPTIONS) autogenerated/bareos-sd-config-schema.json

include/autogenerated/bareos-fd-*.rst.inc: autogenerated/bareos-fd-config-schema.json
	# generates all file daemon resource files
	$(GENERATE_RESOURCE_DESCRIPTIONS) autogenerated/bareos-fd-config-schema.json

include/autogenerated/bconsole-*.rst.inc: autogenerated/bconsole-config-schema.json
	# generates all bconsole resource files
	$(GENERATE_RESOURCE_DESCRIPTIONS) autogenerated/bconsole-config-schema.json

include/autogenerated/bareos-tray-monitor-*.rst.inc: autogenerated/bareos-tray-monitor-config-schema.json
	# generates all tray-monitor resource files
	$(GENERATE_RESOURCE_DESCRIPTIONS) autogenerated/bareos-tray-monitor-config-schema.json

autogenerated/bareos-dir-config-schema.json:
	# generate config-schema file.
	# Test if creation succeeded, if yes, redirect output to a json file.
	$(BAREOS_DIR) -xs >/dev/null && \
		$(BAREOS_DIR) -xs > autogenerated/bareos-dir-config-schema.json;

autogenerated/bareos-sd-config-schema.json:
	# generate config-schema file.
	# Test if creation succeeded, if yes, redirect output to a json file.
	$(BAREOS_SD) -xs >/dev/null && \
		$(BAREOS_SD) -xs > autogenerated/bareos-sd-config-schema.json;

autogenerated/bareos-fd-config-schema.json:
	# generate config-schema file.
	# Test if creation succeeded, if yes, redirect output to a json file.
	$(BAREOS_FD) -xs >/dev/null && \
		$(BAREOS_FD) -xs > autogenerated/bareos-fd-config-schema.json;

autogenerated/bconsole-config-schema.json:
	# generate config-schema file.
	# Test if creation succeeded, if yes, redirect output to a json file.
	$(BCONSOLE) -xs >/dev/null && \
		$(BCONSOLE) -xs > autogenerated/bconsole-config-schema.json;

autogenerated/bareos-tray-monitor-config-schema.json:
	# generate config-schema file.
	# Test if creation succeeded, if yes, redirect output to a json file.
	$(BAREOS_TRAY_MONITOR) -xs >/dev/null && \
		$(BAREOS_TRAY_MONITOR) -xs > autogenerated/bareos-tray-monitor-config-schema.json;

autogenerated: $(GENERATED)

autogenerated-json:
	rm -rf autogenerated/*.json
	make autogenerated
	@git diff --quiet source/include/autogenerated/ || echo "!!! *** Attention, config directive has changed *** !!!"

sphinx:
	#sphinx-versioning -l source/conf.py  build docs/manuals/en/new_main_reference/source/ docs/manuals/en/new_main_reference/BareosMainReference/
	@$(SPHINXBUILD) -M html "$(SOURCEDIR)" "$(BUILDDIR)" $(SPHINXOPTS) $(O)
	#@$(SPHINXBUILD) -M latexpdf "$(SOURCEDIR)" "$(BUILDDIR)" $(SPHINXOPTS) $(O)

clean:
	rm -rf build/*
	rm -rf BareosMainReference/*
	rm -rf autogenerated/*.rst.inc

